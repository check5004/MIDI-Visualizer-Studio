# **詳細外部設計書 v2.3 \- MIDI Visualizer Studio**

## **1\. プロジェクト概要**

* **システム名**: (仮) MIDI Visualizer Studio  
* **目的・ゴール**:  
  * 配信者やゲーマーが、MIDIデバイスの操作をリアルタイムかつ視覚的に表現できるようにする。  
  * 自分の持っているデバイスに完全にフィットするカスタムレイアウトを作成・共有できる環境を提供する。  
* **ターゲットユーザー**:  
  * **ストリーマー**: 手元操作をOBS等でリッチに見せたい。  
  * **リズムゲーマー**: プレイ中の入力判定や遅延を視覚的に確認したい。  
  * **スキンクリエイター**: こだわりのデバイス再現スキンを作り込みたい。  
* **プラットフォーム**:  
  * **Windows / macOS**: フル機能（背景透過、最前面表示、低遅延MIDI）。  
  * **Web**: 体験版＆OBSブラウザソース用（クロマキー必須、一部MIDI制約あり）。

## **2\. 開発戦略 (Architecture First Strategy)**

* **アーキテクチャ先行アプローチ**:  
  * **方針**: 画面遷移、URL（ルーティング）、ディレクトリ構成、状態管理設計をテキストベースで確定させる。  
  * **デザイン**: 上記の設計図に基づき、FigmaでUIを作成する（Viewの詳細設計）。  
  * **実装**: FigmaのViewと、設計済みのBLoCを結合する。  
* **UX戦略（メンタルモデル形成）**:  
  * 初期テンプレートはあえて用意しない（または最小限にする）。  
  * 初回起動時に強制的に「作成チュートリアル」を開始し、自分の手でデバイスを再現させることで、「このツールは自分で作るものだ」という意識付けを行う。

## **3\. ユーザーストーリーと詳細仕様**

### **US-001: 高度なレイアウト作成とエディタ**

* **概要**: FigmaやPhotoshopのような本格的なベクター/ラスター編集機能を持つエディタ。  
* **UI構造**:  
  * **キャンバス**: 中央のプレビューエリア。ドラッグで配置。  
  * **レイヤーパネル**: パーツの重なり順管理、グルーピング。  
  * **インスペクタ（詳細パネル）**: 選択中のパーツのプロパティ設定。  
* **受け入れ基準 (Scenarios)**:  
  * **グリッド生成 (Excel \+ 数値ハイブリッド)**:  
    * ツールを選択すると、Excelの表挿入のようなマス目が表示され、マウスオーバーで「4x4」などを直感的に指定できる。  
    * 同時にインスペクタ上の数値入力フィールドでも「行：4」「列：4」と指定・修正が可能。  
  * **高度な描画ツール**:  
    * **ベクターパス**: 自由な形を描くペンツール。  
    * **画像マスキング（バケツ塗り）**: インポートしたデバイス写真に対し、光らせたいエリアを塗りつぶしてパーツ化する機能。

### **US-002: 直感的なマッピング (Click & Learn)**

* **概要**: 面倒なMIDI番号調べを不要にする学習機能。  
* **受け入れ基準 (Scenarios)**:  
  * **Click & Learnフロー**:  
    1. エディタ上でパーツをクリック（選択状態）。  
    2. 「MIDI学習ボタン」押下（またはショートカット）。  
    3. 実機のパッドを叩く。  
    4. 即座に信号（Note/CC）が登録され、完了する。  
  * **重複制御オプション**:  
    * 同じ信号を受信した際、「既存の設定を上書き」するか、「重複を許可（複数のパーツが同時に光る）」するかをユーザーが設定可能。

### **US-003: ビジュアルフィードバック (Digital/Pad)**

* **概要**: 打鍵の強さやタイミングを正確かつ魅力的に伝える。  
* **受け入れ基準 (Scenarios)**:  
  * **即時反応 (Instant Response)**:  
    * Note Onで遅延なく（0ms）指定色に点灯。  
    * Note Offで即座に消灯（または設定した減衰時間でフェードアウト）。  
  * **カラーパレットUX**:  
    * カラー設定時に「現在使用中の色」「最近使った色（履歴5件）」を提示し、統一感のある配色を支援する。  
  * **コンテキストメニュー**:  
    * パーツを右クリックすることで、プロパティやコピー/ペースト等の主要機能に素早くアクセスできる。

### **US-004: アナログ入力と無限回転の可視化**

* **概要**: ノブ、フェーダー、無限回転エンコーダーの操作を視覚化する。  
* **デザインスタイル（選択可能）**:  
  * **A. リアル画像回転**: ユーザー画像のノブ自体が回転する。  
  * **B. ベクターメーター**: 円グラフや針をプログラム描画する（サイバー/フラットデザイン向け）。  
  * **C. ハイブリッド**: 背景目盛り画像＋プログラム描画の針。  
* **受け入れ基準 (Scenarios)**:  
  * **絶対値モード (Absolute)**:  
    * Min/Max角度を設定し、MIDI値(0-127)に応じてリニアに回転/描画。  
  * **無限回転モード (Relative)**:  
    * チェックボックス「Relative Mode」で有効化。  
    * **アクション可視化エフェクト**: 値の位置ではなく「操作」を見せる。  
      * **Tint (色変化)**: プラス操作で青、マイナスで赤に一瞬光る。  
      * **Pop (アイコン)**: 操作するたびに「+」「-\>」「\<\<\<」などのアイコンがポップして消える。  
      * **Spin (回転)**: 入力量に応じて画像が相対的に回転する（DJジョグダイヤル風）。

### **US-005: 配信向け背景設定 (Streaming Support)**

* **概要**: OBS等での合成に最適化された表示モード。  
* **受け入れ基準**:  
  * **透過モード (Windowless)**: アプリ版のみ。ウィンドウ枠を消去し、背景を透明化してデスクトップ最前面に描画。  
  * **クロマキーモード**: 背景色をプリセット（GB緑、BB青、白、黒）またはカスタムHex色で塗りつぶす。

## **4\. データ仕様 (Portable & Shareable)**

* **保存形式**: .mvs (MIDI Visualizer Skin)  
* **構造**: Zip圧縮コンテナ  
  * layout.json:  
    * レイアウト情報（座標、サイズ、回転、パスデータ）  
    * ビジュアル設定（色、エフェクトタイプ、ノブのモード）  
    * マッピング情報（初期設定用。インポート時に保持するか選択可）  
  * assets/:  
    * ユーザーがインポートした画像リソース（png, svg）  
* **安全性**: スクリプト実行不可。純粋なデータのみ。

## **5\. 非機能要件**

* **パフォーマンス**:  
  * 60fps以上の描画維持。  
  * MIDIイベント受信から描画までのレイテンシを極小化（リズムゲーム用途に耐えうる設計）。  
* **拡張性**:  
  * 将来的なWebマーケットプレイスでの共有を見据え、単一ファイル（.mvs）での完結を徹底する。  
* **技術スタック**: Flutter, BLoC, Freezed, GoRouter, WindowManager.

## **6\. 画面遷移・ルーティング設計 (Screen & Routing)**

### **6.1 ルーティングテーブル (GoRouter)**

| 画面名 | パス (Path) | 説明 | 必要なBLoC |
| :---- | :---- | :---- | :---- |
| **Splash** | / | アプリ起動時の初期化、設定読み込み。初回起動判定。 | AppBloc |
| **Tutorial** | /tutorial | 初回起動時のウィザード。グリッド生成体験。 | TutorialBloc, EditorBloc |
| **Home** | /home | プロジェクト一覧、新規作成、最近のファイル。 | ProjectListBloc |
| **Editor** | /editor/:projectId | **メイン画面**。編集およびプレイを行う。 | EditorBloc, MidiBloc, HistoryBloc |
| **Settings** | /settings | 全体設定（MIDIデバイス選択、言語、テーマ）。 | SettingsBloc, MidiBloc |

### **6.2 画面詳細定義 (Wireframe Reference)**

※詳細は「12. 画面詳細設計 (UI Structure)」を参照。

## **7\. ディレクトリ構成案 (Feature-First \+ BLoC)**

lib/  
├── main.dart  
├── core/  
│   ├── usecases/              \# Undo/Redo, Copy/Paste logic  
│   └── ...  
├── data/  
│   ├── models/                \# JSON Schema (Freezed)  
│   │   ├── project.dart  
│   │   ├── layer.dart  
│   │   ├── component.dart     \# Interface  
│   │   ├── component\_pad.dart  
│   │   └── component\_knob.dart  
│   └── ...  
└── features/  
    ├── editor/  
    │   ├── bloc/  
    │   │   ├── editor\_bloc.dart  
    │   │   ├── editor\_event.dart  
    │   │   ├── editor\_state.dart  
    │   │   └── history\_bloc.dart  \# Undo/Redo専用  
    │   └── ui/  
    │       ├── editor\_screen.dart  
    │       ├── parts/  
    │       │   ├── editor\_app\_bar.dart  
    │       │   ├── canvas\_view.dart  
    │       │   ├── layer\_panel.dart  
    │       │   ├── inspector\_panel.dart  
    │       │   └── midi\_binding\_dialog.dart  
    │       └── ...

## **8\. 実装フェーズ計画**

### **Step 1: アーキテクチャ実装（土台作り）**

* **Task 1**: 上記ディレクトリ構成の作成と、GoRouterによる空の画面遷移の実装。  
* **Task 2**: EditorBloc のState定義。

### **Step 2: 技術検証 (PoC)**

* **Task 3**: バケツ塗りアルゴリズムの検証。  
* **Task 4**: MIDI入力の検証。

### **Step 3: コア機能実装**

* **Task 5**: エディタのキャンバス描画とドラッグ操作。

## **9\. 詳細データモデル定義 (Data Schema)**

Figmaでのプロパティパネル設計およびJSON構造の基盤となります。

### **9.1 Project (project.dart)**

プロジェクト全体の設定。

{  
  "id": "uuid-v4",  
  "name": "My Korg Layout",  
  "version": "1.0.0",  
  "canvasSize": { "width": 800, "height": 600 },  
  "chromaKeyColor": "\#00FF00",  
  "layers": \[ ...Component\[\] \]  
}

### **9.2 Component (component.dart)**

すべてのパーツの基底クラス。

* id: string (UUID)  
* type: enum (pad, knob, fader, static\_image)  
* name: string ("Pad 1", "Master Vol")  
* position: {x, y}  
* size: {width, height}  
* rotation: double (degrees)  
* zIndex: int (Layer order)  
* isLocked: boolean

### **9.3 ComponentPad (extends Component)**

パッド型パーツの固有データ。

* shape: enum (rect, circle, path)  
* pathData: string (SVG path for custom shape)  
* onColor: hex string (押下時の色)  
* offColor: hex string (非押下時の色)  
* midiBinding: { channel: int, note: int }

### **9.4 ComponentKnob (extends Component)**

ノブ・エンコーダー型パーツの固有データ。

* style: enum (image\_rotate, vector\_arc, hybrid)  
* minAngle: double (-135.0)  
* maxAngle: double (135.0)  
* isRelative: boolean (無限回転モード)  
* relativeEffect: enum (tint, pop, spin)  
* midiBinding: { channel: int, cc: int }

## **10\. BLoC詳細設計 (Events & States)**

### **10.1 EditorBloc**

エディタの全状態を管理する中核Bloc。

**State (EditorState)**:

* status: initial | loading | ready | error  
* project: Project (現在の全データ)  
* selectedComponentIds: Set\<String\>  
* mode: edit | play | overlay

**Events (EditorEvent)**:

* LoadProject(String path)  
* AddComponent(Component item)  
* UpdateComponent(String id, Component newData)  
* SelectComponent(String id, bool multiSelect)  
* ToggleMode(EditorMode mode)

## **11\. エディタ操作仕様 (Interaction & Shortcuts)**

ユーザー体験のコアとなる操作の詳細定義。

### **11.1 マウス操作**

* **左クリック**: パーツ選択（Inspector更新）。  
* **キャンバスの空き領域クリック**: 全選択解除。  
* **ドラッグ (パーツ上)**: パーツ移動。グリッドスナップ有効（10px単位）。  
* **ドラッグ (ハンドル上)**: リサイズまたは回転。  
* **ドラッグ (キャンバス上)**: 範囲選択（矩形選択）。※Spaceキー押下中はパン（視点移動）。  
* **右クリック**: コンテキストメニュー表示。

### **11.2 キーボードショートカット**

* **Cmd/Ctrl \+ Z**: 元に戻す (Undo)  
* **Cmd/Ctrl \+ Shift \+ Z**: やり直し (Redo)  
* **Cmd/Ctrl \+ C**: コピー  
* **Cmd/Ctrl \+ V**: 貼り付け  
* **Cmd/Ctrl \+ D**: 複製  
* **Delete / Backspace**: 選択中のパーツ削除  
* **Shift \+ Click**: 複数選択へ追加/除外  
* **Arrow Keys**: 1px単位の微調整移動（Shift押下で10px）  
* **Esc**: Play/OverlayモードからEditモードへ戻る

### **11.3 ツールバー操作**

* **モード切替**: スイッチ一つで Edit \<-\> Play を切り替え。Playモード中はグリッドやガイドを非表示にする。

## **12\. 画面詳細設計 (UI Structure)**

Figma作成のガイドとなる、各画面の構成要素一覧。

### **12.1 Splash Screen**

* **概要**: アプリ起動時のロード画面。  
* **Components**:  
  * **Logo**: 中央にアプリロゴ。  
  * **LoadingIndicator**: 初期化処理の進捗バー。  
  * **Version Text**: 下部にバージョン情報。

### **12.2 Tutorial Screen (Wizard)**

* **概要**: 初回起動時の強制グリッド生成フロー。  
* **Components**:  
  * **Step Indicator**: 「Step 1: サイズ設定」のような進行表示。  
  * **Preview Area**: 中央。設定に応じたグリッドがリアルタイム表示される。  
  * **Control Panel**:  
    * **Input Fields**: 行数 (Rows)、列数 (Cols)。  
    * **Counter Buttons**: \+ \- ボタンで増減。  
  * **Footer**:  
    * **Skip Button**: チュートリアルを飛ばす（上級者向け）。  
    * **Next / Create Button**: 決定してEditorへ遷移。

### **12.3 Home Screen**

* **概要**: プロジェクト管理。  
* **Sections**:  
  * **Sidebar (Left)**:  
    * **Menu Items**: 「最近の項目」「ローカルファイル」「設定」。  
  * **Main Content**:  
    * **Header**: 「ようこそ、$$User$$  
      さん」  
    * **New Project Card**: 大きな「＋」ボタン。押すとチュートリアル(または空白)から開始。  
    * **Recent Projects Grid**: 過去に編集した .mvs ファイルのサムネイル一覧。  
      * **Thumbnail**: レイアウトの縮小画像。  
      * **Meta**: ファイル名、最終更新日時。

### **12.4 Editor Screen (Main)**

* **概要**: 編集とプレイを行うメイン画面。  
* **Layout Structure**:  
  * **Top Bar (App Bar)**:  
    * **Left**: ハンバーガーメニュー、戻るボタン（Homeへ）、プロジェクト名（タップでリネーム）。  
    * **Center**: ツールバー（選択、矩形、円、パス、画像追加）。  
    * **Right**:  
      * **MIDI Status**: インジケータ（信号受信で点滅）。  
      * **Undo/Redo Icons**.  
      * **Zoom Control**: %, \-, \+  
      * **Mode Switch**: Edit / Play 切り替えトグル。  
  * **Left Sidebar (Layers)**:  
    * **Toolbar**: グループ化、ロック、表示/非表示切り替え。  
    * **List View**: ドラッグで並び替え可能なレイヤーリスト。  
  * **Center Area (Canvas)**:  
    * **Viewport**: 無限キャンバス（または固定サイズ枠）。  
    * **Rulers/Grid**: 目盛りとグリッド線（Editモードのみ）。  
  * **Right Sidebar (Inspector)**:  
    * **Contextual**: 何も選択していない時は「Project Settings（キャンバスサイズ、背景色）」を表示。選択時は「Component Properties」を表示。  
    * **Properties Group**:  
      * **Transform**: X, Y, W, H, Rotation.  
      * **Appearance**: Fill, Stroke, Opacity. (Shape固有設定含む)  
      * **MIDI Binding**:  
        * **Learn Button**: 赤丸録画アイコン。  
        * **Status**: "Note 36 (C1) on Ch 10" のようなテキスト。  
        * **Behavior**: Mode (Absolute/Relative), Effect Type選択。

### **12.5 Settings Dialog**

* **概要**: モーダルウィンドウとして表示。  
* **Tabs**:  
  * **General**: 言語設定、テーマ（Dark/Light）。  
  * **MIDI**:  
    * **Input Devices**: 検出されたデバイスのチェックリスト。  
  * **Streaming**:  
    * **Chroma Key**: 背景色のプリセット選択 (Green, Blue, Custom)。

## **13\. 推奨ライブラリとバージョン要件 (Dependencies)**

開発開始時の環境構築用リファレンス。

* **SDK**: Flutter (Latest Stable)  
* **Lint**: flutter\_lints (Recommended)  
* **State Management**:  
  * flutter\_bloc:  (BLoC Pattern)  
  * equatable:  (Value comparison)  
* **Routing**:  
  * go\_router:  (URL-based routing)  
* **Data & Serialization**:  
  * freezed\_annotation:   
  * json\_annotation:   
  * uuid:   
  * shared\_preferences: (For simple settings)  
  * archive: (For Zip handling)  
* **UI & Platform**:  
  * window\_manager: (For window control)  
  * file\_picker: (For importing images)  
* **MIDI**:  
  * flutter\_midi\_command: (要検証候補)